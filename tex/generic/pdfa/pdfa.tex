% pdfa.tex (RMCG20140502)
%    adapted to plain tex from pdfx.sty
%    only pdfa supported

\let\next=\endinput
\ifx\pdfoutput\undefined
 \errhelp={pdfa.tex only works if index.tex was already loaded.}
 \errmessage{pdfa.tex: index.tex was not loaded!}
\else
 \ifcase\pdfoutput
  \errhelp={pdfa.tex does not make sense if output is not pdf.}
  \errmessage{pdfa.tex: output is not pdf!}
 \else
  \let\next=\relax
 \fi
\fi
\next

\pdfminorversion=4

\edef\atcatcode{\the\catcode`\@}
\edef\quotecatcode{\the\catcode`\"}
\catcode`\@=11
\catcode`\"=12
\def\@gobble#1{}

\def\hash{\expandafter\@gobble\string\#}
\def\amp{\expandafter\@gobble\string\&}
\def\xmpAmp{\amp\hash x0026;}
\def\sep{</rdf:li><rdf:li>}
\def\TextCopyright{\amp\hash x00A9;}

\def\dountil#1\continue{\def\body{#1}\reiterate}
\def\reiterate{\body \let\next\relax \else \let\next\reiterate \fi \next}
\let\continue=\fi

\def\allhighother{\count@=128
 \loop \catcode\count@=12 \ifnum\count@<255 \advance\count@ by 1\repeat}

% \^^b3 -> ^^f3
{\allhighother \count@="80 \count@@="C0
 \loop \lccode`a\count@ \lccode`z\count@@
 \lowercase{\expandafter\xdef\csname a\endcsname{z}}%
 \ifnum\count@@<"FF \advance\count@ 1 \advance\count@@ 1 \repeat
}

\def\@utf{\allhighother \catcode`\^^c2=13 \catcode`\^^c3=0 }

\def\Title#1{\gdef\xmpTitle{#1}}
\ifx\xmpTitle\undefined \let\xmpTitle\empty \fi
\def\Author#1{\gdef\xmpAuthor{#1}} %%%%%%%%%%%%%%%%%%%%% clash with doc.tex
\ifx\xmpAuthor\undefined \let\xmpAuthor\empty \fi
\def\Org#1{\gdef\xmpOrg{#1}}
\ifx\xmpOrg\undefined \let\xmpOrg\empty \fi
\def\Copyright#1{\gdef\xmpCopyright{#1}}
\ifx\xmpCopyright\undefined \let\xmpCopyright\empty \fi
\def\Doi#1{\gdef\xmpDoi{#1}}
\ifx\xmpDoi\undefined \let\xmpDoi\empty \fi
\def\Subject#1{\gdef\xmpSubject{#1}}
\ifx\xmpSubject\undefined \let\xmpSubject\empty \fi
\def\Keywords#1{\gdef\xmpKeywords{#1}}
\ifx\xmpKeywords\undefined \let\xmpKeywords\empty \fi
\def\Journaltitle#1{\gdef\xmpJournaltitle{#1}}
\ifx\xmpJournaltitle\undefined \let\xmpJournaltitle\empty \fi
\def\Journalnumber#1{\gdef\xmpJournalnumber{#1}}
\ifx\xmpJournalnumber\undefined \let\xmpJournalnumber\empty \fi
\def\Volume#1{\gdef\xmpVolume{#1}}
\ifx\xmpVolume\undefined \let\xmpVolume\empty \fi
\def\Issue#1{\gdef\xmpIssue{#1}}
\ifx\xmpIssue\undefined \let\xmpIssue\empty \fi
\def\CoverDate#1{\gdef\xmpCoverDate{#1}}
\ifx\xmpCoverDate\undefined \let\xmpCoverDate\empty \fi
\def\CoverDisplayDate#1{\gdef\xmpCoverDisplayDate{#1}}
\ifx\xmpCoverDisplayDate\undefined \let\xmpCoverDisplayDate\empty \fi
\def\Firstpage#1{\gdef\xmpFirstpage{#1}}
\ifx\xmpFirstpage\undefined \let\xmpFirstpage\empty \fi
\def\Lastpage#1{\gdef\xmpLastpage{#1}}
\ifx\xmpLastpage\undefined \let\xmpLastpage\empty \fi
\def\Creator#1{\gdef\xmpCreator{#1}}
\ifx\xmpCreator\undefined \def\xmpCreator{TeX}\fi
\def\Producer#1{\gdef\xmpProducer{#1}}
\ifx\xmpProducer\undefined \def\xmpProducer{pdfTeX}\fi
\def\CreatorTool#1{\gdef\xmpCreatorTool{#1}}
\ifx\xmpCreatorTool\undefined \def\xmpCreatorTool{\xmpProducer}\fi
\def\AuthoritativeDomain#1{\gdef\xmpAuthoritativeDomain{#1}}
\ifx\xmpAuthoritativeDomain\undefined \let\xmpAuthoritativeDomain\empty \fi

\def\findUUID#1{\edef\tmpstring{\pdfmdfivesum{#1}}
     \expandafter\eightofnine\tmpstring\end}
\def\eightofnine#1#2#3#4#5#6#7#8#9\end{%
     \xdef\eightchars{#1#2#3#4#5#6#7#8}
     \fouroffive#9\end}
\def\fouroffive#1#2#3#4#5\end{\xdef\ffourchars{#1#2#3#4}
     \sfouroffive#5\end}
\def\sfouroffive#1#2#3#4#5\end{\xdef\sfourchars{#1#2#3#4}
     \tfouroffive#5\end}
\def\tfouroffive#1#2#3#4#5\end{\xdef\tfourchars{#1#2#3#4}
     \xdef\laststring{#5}}

\def\uuid{\eightchars-\ffourchars-\sfourchars-\tfourchars-\laststring}

\findUUID{\jobname.pdf}
\edef\xmpdocid{\uuid}
\findUUID{\pdfcreationdate}
\edef\xmpinstid{\uuid}

\newif\ifxmpf
\openin\infile=\jobname.xmpdata
\ifeof\infile \xmpffalse \else \xmpftrue \fi
\closein\infile

 \ifxmpf
\begingroup
 \allhighother
 \input \jobname.xmpdata
\endgroup
\fi

\def\convertDate{\getYear}
{\catcode`\D=12
 \gdef\getYear D:#1#2#3#4{\edef\xYear{#1#2#3#4}\getMonth}
}
\def\getMonth#1#2{\edef\xMonth{#1#2}\getDay}
\def\getDay#1#2{\edef\xDay{#1#2}\getHour}
\def\getHour#1#2{\edef\xHour{#1#2}\getMin}
\def\getMin#1#2{\edef\xMin{#1#2}\getSec}
\def\getSec#1#2{\edef\xSec{#1#2}\getTZh}
\def\getTZh +#1#2{\edef\xTZh{#1#2}\getTZm}
\def\getTZm '#1#2'{%
    \edef\xTZm{#1#2}%
    \edef\convDate{\xYear-\xMonth-\xDay
      T\xHour:\xMin:\xSec+\xTZh:\xTZm}}
\expandafter\convertDate\pdfcreationdate

\immediate\pdfobj stream attr{/N 4} file{sRGBIEC1966-2.1.icm}
\edef\OBJ@RVT{\the\pdflastobj}
\pdfcatalog{%
 /OutputIntents [ <<
  /Type /OutputIntent
  /S/GTS_PDFA1
  /DestOutputProfile \OBJ@RVT\space 0 R
  /OutputConditionIdentifier (sRGB IEC61966-2.1)
  /Info (sRGB IEC61966-2.1)
 >> ]}

\newwrite\xmpinclWrite
\newread\xmpinclRead

\def\mcs@xmpincl@patchFile#1{\begingroup
 \catcode`\#=12 \catcode`\~=12 \catcode`\&=12
 \@utf \let^^c2\Acircumflex
 \count@="80 \loop\lccode`a\count@
  \lowercase{\expandafter\edef\csname a\endcsname{\Atilde a}}%
 \ifnum\count@<"BF \advance\count@1 \repeat
 \immediate\openin\xmpinclRead #1.xmp
 \immediate\openout\xmpinclWrite auxiliar.xmp
 \immediate\write\xmpinclWrite{<?xpacket begin='' id='W5M0MpCehiHzreSzNTczkc9d'?>}%
 \dountil
  \immediate\read\xmpinclRead to\xmpinclReadln
  \if\xmpinclReadln\endgraf\else
   \immediate\write\xmpinclWrite{\xmpinclReadln}%
  \fi
 \ifeof\xmpinclRead\continue
 \immediate\write\xmpinclWrite{<?xpacket end='r'?>}
 \immediate\closein\xmpinclRead
 \immediate\closeout\xmpinclWrite
 \endgroup
}

\def\includexmp#1{\begingroup \pdfcompresslevel=0
 \immediate\openin\xmpinclRead #1.xmp
 \mcs@xmpincl@patchFile{#1}
 \immediate\pdfobj stream attr {/Type /Metadata /Subtype /XML} file{auxiliar.xmp}
 \pdfcatalog{/Metadata \the\pdflastobj\space 0 R}
 \endgroup
}

\begingroup
\let\&=\xmpAmp
\includexmp{pdfa-1b}
\endgroup

\input glyphtounicode.tex
\input glyphtounicode-cmr.tex
\pdfgentounicode=1

% modifying index.tex definitions for links
\let\typelink=\namelink
\let\fourdigits=\number

\begingroup
 \def\sep{;\space}\@utf \let^^c2\empty
 \ifxmpf \input \jobname.xmpdata \fi
 \pdfinfo{%
  \ifx\xmpTitle\empty\else /Title (\xmpTitle) \fi
  \ifx\xmpAuthor\empty\else /Author (\xmpAuthor) \fi
  \ifx\xmpSubject\empty\else /Subject (\xmpSubject) \fi
  \ifx\xmpKeywords\empty\else /Keywords (\xmpKeywords) \fi
  /Trapped /False
  /GTS_PDFA1Version (PDF/A-1b:2005)
 }
\endgroup

\catcode`\@=\atcatcode
\catcode`\"=\quotecatcode
\endinput
