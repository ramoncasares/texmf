% xpplain.tex (RMCG19970828)

\chardef\CRoldatcatcode=\catcode`\@\catcode`\@=11

% SAVE PLAIN

\ifx\saveplain\undefined

\def\saveplain#1{\expandafter\let\csname plain\string#1\endcsname=#1}
\def\plain#1{\csname plain\string#1\endcsname}
\def\restoreplain#1{\expandafter\let
 \expandafter#1\csname plain\string#1\endcsname}

\else \message{Macro saveplain already defined!}

\fi

% CASES

\ifx\corkcases\undefined

\newcount\count@@
\def\corkcases{% First two OT1 exceptions
 \lccode"10="10 \uccode"10=`I % dotless OT1 (cm) i
 \lccode"11="11 \uccode"11=`J % dotless OT1 (cm) j
 \count@="80 \count@@="A0 \loop
  \lccode\count@=\count@@ \uccode\count@=\count@
  \lccode\count@@=\count@@ \uccode\count@@=\count@
  \ifnum\count@<"9C \advance\count@1 \advance\count@@1 \repeat
 \lccode"9D=`i \uccode"9D="9D
 \count@="C0 \count@@="E0 \loop
  \lccode\count@=\count@@ \uccode\count@=\count@
  \lccode\count@@=\count@@ \uccode\count@@=\count@
  \ifnum\count@<"DF \advance\count@1 \advance\count@@1 \repeat}

\def\plaincases{%
 \lccode"10=0 \uccode"10=0 % dotless i
 \lccode"11=0 \uccode"11=0 % dotless j
 \count@="80 \loop \lccode\count@=0 \uccode\count@=0
  \ifnum\count@<"FF \advance\count@1 \repeat}

\else \message{Macro corkcases already defined!}

\fi

% INPUT

% Lists

\def\activate{\def\do##1{\catcode`##1=13}}
\def\deactivate{\def\do##1{\catcode`##1=12}}
\def\stringate{\def\do##1{\def##1{\string##1}}}
\def\noexpandate{\def\do##1{\def##1{\noexpand##1}}}

\def\activateall{\count@=128 \loop \catcode\count@=13
 \ifnum\count@<255 \advance\count@1 \repeat}
\activateall
\let^^c2=\empty

\def\dohigh{%
 \do^^80\do^^81\do^^82\do^^83\do^^84\do^^85\do^^86\do^^87%
 \do^^88\do^^89\do^^8a\do^^8b\do^^8c\do^^8d\do^^8e\do^^8f%
 \do^^90\do^^91\do^^92\do^^93\do^^94\do^^95\do^^96\do^^97%
 \do^^98\do^^99\do^^9a\do^^9b\do^^9c\do^^9d\do^^9e\do^^9f%
 \do^^a0\do^^a1\do^^a2\do^^a3\do^^a4\do^^a5\do^^a6\do^^a7%
 \do^^a8\do^^a9\do^^aa\do^^ab\do^^ac\do^^ad\do^^ae\do^^af%
 \do^^b0\do^^b1\do^^b2\do^^b3\do^^b4\do^^b5\do^^b6\do^^b7%
 \do^^b8\do^^b9\do^^ba\do^^bb\do^^bc\do^^bd\do^^be\do^^bf%
 \do^^c0\do^^c1\do^^c2\do^^c3\do^^c4\do^^c5\do^^c6\do^^c7%
 \do^^c8\do^^c9\do^^ca\do^^cb\do^^cc\do^^cd\do^^ce\do^^cf%
 \do^^d0\do^^d1\do^^d2\do^^d3\do^^d4\do^^d5\do^^d6\do^^d7%
 \do^^d8\do^^d9\do^^da\do^^db\do^^dc\do^^dd\do^^de\do^^df%
 \do^^e0\do^^e1\do^^e2\do^^e3\do^^e4\do^^e5\do^^e6\do^^e7%
 \do^^e8\do^^e9\do^^ea\do^^eb\do^^ec\do^^ed\do^^ee\do^^ef%
 \do^^f0\do^^f1\do^^f2\do^^f3\do^^f4\do^^f5\do^^f6\do^^f7%
 \do^^f8\do^^f9\do^^fa\do^^fb\do^^fc\do^^fd\do^^fe\do^^ff%
}

% ANSI (Win) input coding

\def\dosymbols{\do^^a1\do^^bf\do^^aa\do^^ba\do^^ab\do^^bb}
\def\ansisymbols{\activate\dosymbols
 \def^^a1{!`}\def^^bf{?`}%
 \def^^aa{\tura a}\def^^ba{\tura o}%
 \def^^ab{``}\def^^bb{''}}

\def\doaccents{\do^^c1\do^^e1\do^^c9\do^^e9\do^^cd\do^^ed%
 \do^^d1\do^^f1\do^^d3\do^^f3\do^^da\do^^fa\do^^dc\do^^fc}
\def\ansiaccents{\activate\doaccents
 \def^^c1{\'A}\def^^e1{\'a}%
 \def^^c9{\'E}\def^^e9{\'e}%
 \def^^cd{\'I}\def^^ed{\'i}%
 \def^^d1{\~N}\def^^f1{\~n}%
 \def^^d3{\'O}\def^^f3{\'o}%
 \def^^da{\'U}\def^^fa{\'u}%
 \def^^dc{\"U}\def^^fc{\"u}}

% UTF-8 input encoding

\def\utf@ac{\def\^^81{\'A}\def\^^a1{\'a}%
 \def\^^89{\'E}\def\^^a9{\'e}\def\^^8d{\'I}\def\^^ad{\'i}%
 \def\^^91{\~N}\def\^^b1{\~n}\def\^^93{\'O}\def\^^b3{\'o}%
 \def\^^9a{\'U}\def\^^ba{\'u}\def\^^9c{\"U}\def\^^bc{\"u}}

\deactivate\dohigh
\def\Acircumflex{^^c2}
\def\Atilde{^^c3}

\def\utf@ch{\def\^^81{^^c1}\def\^^a1{^^e1}%
 \def\^^89{^^c9}\def\^^a9{^^e9}\def\^^8d{^^cd}\def\^^ad{^^ed}%
 \def\^^91{^^d1}\def\^^b1{^^f1}\def\^^93{^^d3}\def\^^b3{^^f3}%
 \def\^^9a{^^da}\def\^^ba{^^fa}\def\^^9c{^^dc}\def\^^bc{^^fc}}

\def\utf@Ch{%
 \def\^^80{^^c0}\def\^^81{^^c1}\def\^^82{^^c2}\def\^^83{^^c3}%
 \def\^^84{^^c4}\def\^^85{^^c5}\def\^^86{^^c6}\def\^^87{^^c7}%
 \def\^^88{^^c8}\def\^^89{^^c9}\def\^^8a{^^ca}\def\^^8b{^^cb}%
 \def\^^8c{^^cc}\def\^^8d{^^cd}\def\^^8e{^^ce}\def\^^8f{^^cf}%
 \def\^^90{^^d0}\def\^^91{^^d1}\def\^^92{^^d2}\def\^^93{^^d3}%
 \def\^^94{^^d4}\def\^^95{^^d5}\def\^^96{^^d6}\def\^^97{^^d7}%
 \def\^^98{^^d8}\def\^^99{^^d9}\def\^^9a{^^da}\def\^^9b{^^db}%
 \def\^^9c{^^dc}\def\^^9d{^^dd}\def\^^9e{^^de}\def\^^9f{^^df}%
 \def\^^a0{^^e0}\def\^^a1{^^e1}\def\^^a2{^^e2}\def\^^a3{^^e3}%
 \def\^^a4{^^e4}\def\^^a5{^^e5}\def\^^a6{^^e6}\def\^^a7{^^e7}%
 \def\^^a8{^^e8}\def\^^a9{^^e9}\def\^^aa{^^ea}\def\^^ab{^^eb}%
 \def\^^ac{^^ec}\def\^^ad{^^ed}\def\^^ae{^^ee}\def\^^af{^^ef}%
 \def\^^b0{^^f0}\def\^^b1{^^f1}\def\^^b2{^^f2}\def\^^b3{^^f3}%
 \def\^^b4{^^f4}\def\^^b5{^^f5}\def\^^b6{^^f6}\def\^^b7{^^f7}%
 \def\^^b8{^^f8}\def\^^b9{^^f9}\def\^^ba{^^fa}\def\^^bb{^^fb}%
 \def\^^bc{^^fc}\def\^^bd{^^fd}\def\^^be{^^fe}\def\^^bf{^^ff}}

\def\utf{\catcode`\^^c2=13\catcode`\^^c3=0\relax}

\def\noutf{\catcode`\^^c2=12\catcode`\^^c3=12
 \let\^^81=\relax \let\^^a1=\relax
 \let\^^89=\relax \let\^^a9=\relax \let\^^8d=\relax \let\^^ad=\relax
 \let\^^91=\relax \let\^^b1=\relax \let\^^93=\relax \let\^^b3=\relax
 \let\^^9a=\relax \let\^^ba=\relax \let\^^9c=\relax \let\^^bc=\relax}

% ACCENTS

\saveplain\accent \saveplain\' \saveplain\~ \saveplain\"

\def\expandaccents{\def\'{\@ccent\acutechar}\def\~{\@ccent\tildechar}%
 \def\"{\@ccent\dieresischar}}
\def\noexpandaccents{\def\'{\noexpand\'}\def\~{\noexpand\~}%
 \def\"{\noexpand\"}}
\def\stringaccents{\def\'{\string\'}\def\~{\string\~}\def\"{\string\"}}

\def\accents{\let\@ccent=\accent\expandaccents}
\def\kaccents{\let\@ccent=\kaccent\expandaccents}
\def\plainaccents{\restoreplain\accent
 \restoreplain\'\restoreplain\~\restoreplain\"}

% Kerned accent

\def\kaccent#1#2{\ifx#2i\i\count@=\spacefactor\let\d@s=\i\else
 #2\count@=\spacefactor\let\d@s=#2\relax\fi
 {\setbox0\hbox{#1}\setbox2\hbox{\d@s}%
  \dimen0=\wd2 \advance\dimen0 by \wd0 \divide\dimen0 by 2
  \dimen2=\ht2 \advance\dimen2 by -1ex
  \dimen4=\wd2 \advance\dimen4 by -\wd0 \divide\dimen4 by 2
  \ifdim\dimen2=0pt
   \@kern{-\dimen0}#1\@kern{\dimen4}%
  \else
   \count0=\fontdimen1\font
   \advance\count0 by128 \divide\count0 by256
   \count2=\dimen2 \advance\count2 by127 \divide\count2 by256
   \multiply\count0 by \count2
   \advance\dimen0 by -\count0sp
   \advance\dimen4 by -\count0sp
   \@kern{-\dimen0}\raise\dimen2\box0\@kern{\dimen4}\fi}%
 \let\pr@k=\d@s\futurelet\p@stk\k@rn}

\def\k@rn{\ifcat\space\noexpand\p@stk \null \else
 {\ifx\/\p@stk \setbox0=\hbox{\pr@k\/}\dimen0=\wd0
  \setbox0=\hbox{\pr@k}\advance\dimen0 by-\wd0
  \null\@kern{\dimen0}\else \ifcat a\noexpand\p@stk \else
   \ifcat =\noexpand\p@stk \else \let\p@stk=\relax \fi\fi
   \setbox0=\hbox{\pr@k\p@stk}\dimen0=\wd0
   \setbox0=\hbox{\pr@k\noboundary\p@stk}\advance\dimen0 by-\wd0
   \@kern{\dimen0}\penalty\@M\hskip\z@skip \fi}%
 \fi \spacefactor=\count@}

\def\@kern#1{\ifdim#1=0pt\else\kern#1\fi}

% OUTPUT

\saveplain\i \saveplain\j

\def\plainfont{\ansiaccents \utf\utf@ac \ansisymbols
 \restoreplain\i \restoreplain\j
 \chardef\acutechar="13 \chardef\tildechar="7E \chardef\dieresischar="7F }

\def\corkfont{\deactivate\doaccents \utf\utf@ch \ansisymbols
 \chardef\i="19 \chardef\j="1A
 \chardef\acutechar="01 \chardef\tildechar="03 \chardef\dieresischar="04 }

\def\ansifont{\deactivate\dohigh \utf\utf@Ch
 \chardef\i="10 \chardef\j="11
 \chardef\acutechar="B4 \chardef\tildechar="98 \chardef\dieresischar="A8 }

% MISCELANEOUS

\saveplain\message \saveplain\mark
\def\message#1{{\stringaccents\deactivate\dohigh\plain\message{#1}}}
\def\mark#1{{\noexpandaccents\deactivate\dohigh\plain\mark{#1}}}

\def\Plain#1{\expandafter\let\expandafter\next
 \csname plain\string#1\endcsname
 \ifx\next\relax\let\next=#1\fi \next}

\def\tura#1{{\edef\scf@{\the\scriptfont\fam}%
 \ifdim\fontdimen6\scf@=0pt\else\scf@\fi $^{\hbox{\b{#1}}}$}}

% DEFAULTS (reset to plain defaults)

\def\plaindefaults{\english \plaincases \deactivate\dohigh
 \plainaccents \restoreplain\i \restoreplain\j
 \restoreplain\message \restoreplain\mark }

\catcode`\@=\CRoldatcatcode

\endinput

\saveplain\write
\def\escribe{\afterassignment\@scribe\count@=}
 \def\@scribe#1{{\noexpandaccents\stringactives
  \immediate\plain\write\count@{#1}}}
